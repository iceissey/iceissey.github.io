const IssuesAPI={requestIssuesAPI(n,r,l){let o=10;!function a(){new Promise((s,e)=>{let t=0,i=setTimeout(()=>{0===t&&(t=2,i=null,e("请求超时"),0==o&&l())},5e3);fetch(n).then(function(e){if(2!==t&&(clearTimeout(i),s(e),i=null,t=1),e.ok)return e.json();throw new Error("Network response was not ok.")}).then(function(e){o=0,r(e)}).catch(function(e){0<o?(--o,setTimeout(()=>{a()},5e3)):l()})})}()},parseIssueStrToJson(e){let s=e.match(/```json[\s|\S]*```/);if(s=(s=s&&0<s.length?s[0]:s)&&s.split("```json")[1].split("```")[0])return JSON.parse(s)},groupIssuesData(s,t){var a=new Object;if(0<t.length)if(null!=s.group){var n=s.group.split(":");if(1<n.length){var r=n[0];let e=n[1];for(r&&e&&(e=e.split(",")),s.group=e,i=0;i<t.length;i++){var l=this.parseIssueStrToJson(t[i].body);if(l&&r in l){let s=l[r];s=s.replace(", ",",").split(",");for(var o=0;o<s.length;o++)if(e.includes(s[o])){let e=a[s[o]];(e=null==e?new Array:e).push(l),a[s[o]]=e}}}}}else for(s.group=[""],i=0;i<t.length;i++){var p=this.parseIssueStrToJson(t[i].body);if(p){let e=a[""];(e=null==e?new Array:e).push(p),a[""]=e}}return a},getIssuesAPIForSites(t){let r=$(t.el)[0];$(r).append('<div class="loading"><i class="fa fa-cog fa-2x fa-spin"></i><p>正在加载</p></div>'),this.requestIssuesAPI(t.api,function(e){$(r).find(".loading").remove();let s=IssuesAPI.groupIssuesData(t,e),n=Object.keys(s);t.group.forEach((e,t)=>{var i=s[e];if(i&&0<i.length)for(0<e.length?$(r).append("<h2>"+e+"</h2>"):""==name&&1<n.length&&$(r).append("<h2>未分组</h2>"),$(r).append('<div class="site-card-group '+t+'"></div>'),j=0;j<i.length;j++){var a=i[j];let e="",s=(e=a.screenshot&&0<a.screenshot.length?'<div class="img"><img src="'+a.screenshot+'" onerror="javascript:this.src=\'https://image.thum.io/get/width/1024/crop/768/'+a.url+"';\"/></div>":'<div class="img"></div>','<div class="info">');a.avatar&&0<a.avatar.length&&(s+='<img src="'+a.avatar+'" onerror="javascript:this.src=\'https://image.thum.io/get/width/1024/crop/768/'+a.url+"';\"/>"),s+='<span class="title">'+a.title+'</span><span class="desc">'+a.description+"</span></div>";a="<a class='site-card' target='_blank' href='"+a.url+"'>"+e+s+"</a>";$(r).find(".site-card-group."+t).append(a)}})},function(){$(r).find(".loading i").remove(),$(r).find(".loading p").text("加载失败，请稍后重试。")})},getIssuesAPIForTimeline(e){let t=$(e.el)[0];$(t).append('<div class="loading"><i class="fa fa-cog fa-2x fa-spin"></i><p>正在加载</p></div>'),this.requestIssuesAPI(e.api,function(e){if($(t).find(".loading").remove(),0<e.length)for(i=0;i<e.length;i++){var s='&nbsp;&nbsp;<a class="comments" target="_blank" href="'+e[i].html_url+'"><i class="fa fa-comment-dots fa-fw"></i>'+e[i].comments+"</a>",s='<div class="timenode">'+('<div class="meta"><p></p><p>'+e[i].title+s+"</p><p></p></div>")+('<div class="body"><p>'+e[i].body+"</p></div>")+"</div>";$(t).append(s)}},function(){$(t).find(".loading i").remove(),$(t).find(".loading p").text("加载失败，请稍后重试。")})},request(){for(var s=document.getElementsByClassName("issues-api"),t=0;t<s.length;t++){let e=s[t];var i=e.getAttribute("api"),a=e.getAttribute("group"),n=new Object;n.class=e.getAttribute("class"),n.el=e,n.api=i,n.group=a,n.class.split(" ").includes("sites")?this.getIssuesAPIForSites(n):n.class.split(" ").includes("timeline")&&this.getIssuesAPIForTimeline(n)}}};IssuesAPI.request(),document.addEventListener("pjax:complete",function(){IssuesAPI.request()});